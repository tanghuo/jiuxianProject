<?php if (!defined('THINK_PATH')) exit(); var_dump($_POST); var_dump($_FILES); try { $user="root"; $pass="123456789"; $PDO=new PDO("mysql:host=localhost;dbname=jiuxian",$user,$pass); $PDO->setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_EXCEPTION ); $PDO->beginTransaction(); $query="SELECT * FROM shopitem WHERE item_id = ?"; $PDOD = $PDO->prepare($query) ; $PDOD ->bindParam(1,$_POST["item_id"]); $PDOD -> execute(); if( ($PDOD->fetchAll(PDO::FETCH_ASSOC)) ){ echo "商品ID已经存在!"; exit; } $query = "insert shopitem(item_id,item_detail,item_price,item_store,item_belong,bigPrice,item_bianhao,sendcoin) 
				  values(?,?,?,?,?,?,?,?)"; $PDO2 = $PDO->prepare($query) ; $PDO2 ->bindParam(1,chkpost($_POST["item_id"])); $PDO2 ->bindParam(2,chkpost($_POST["item_name"])); $PDO2 ->bindParam(3,chkpost($_POST["item_price"])); $PDO2 ->bindParam(4,chkpost($_POST["item_store"])); $PDO2 ->bindParam(5,chkpost($_POST["item_shopname"])); $PDO2 ->bindParam(6,chkpost($_POST["item_bigprice"])); $PDO2 ->bindParam(7,chkpost($_POST["item_biaohao"])); $PDO2 ->bindParam(8,chkpost($_POST["sendcoin"])); $PDO2 -> execute(); if($_FILES){ $query = "insert item_pic values(?,?,?)"; $PDO2 = $PDO->prepare($query) ; $PDO2 ->bindParam(1,$item_id); $PDO2 ->bindParam(2,$pic_addr); $PDO2 ->bindParam(3,$pic_shunxu); foreach ($_FILES as $key => $value) { $name_medium = substr($key, -1); $name = $name_medium.time(); $name .= $value["name"]; $path = "./public/img/item/"; $path .= $name ; echo "<br/>"; echo "name=".$name; echo "<br/>"; echo "path=".$path; echo "<br/>"; if( move_uploaded_file($value["tmp_name"],$path)){ echo "upload success"; $item_id=$_POST["item_id"]; $path = "__ROOT__/public/img/item/"; $path .= $name; $pic_addr=$path; $pic_shunxu=$name_medium; $PDO2 ->execute(); } else{ echo "upload failed"; } } } $PDO->commit(); } catch (Exception $e) { print "Error!: " . $e->getMessage() . "<br/>"; echo "参数填写不正确"; $PDO -> rollBack(); } function chkID($in){ } function chkpost($in){ if(!($in)){ return 0; } else return $in; } ?>